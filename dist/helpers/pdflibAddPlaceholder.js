"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const pdf_lib_1 = require("pdf-lib");
const const_1 = require("./const");
const pdfkitReferenceMock_1 = require("./pdfkitReferenceMock");
const SignPdfError_1 = require("../SignPdfError");
const defaultOpts = {
    signatureLength: const_1.DEFAULT_SIGNATURE_LENGTH,
    byteRangePlaceholder: const_1.DEFAULT_BYTE_RANGE_PLACEHOLDER
};
async function pdflibAddPlaceholder(opts) {
    const { pdfBuffer, infoSignature, signatureLength, byteRangePlaceholder } = {
        ...defaultOpts, ...opts
    };
    let pdfDoc;
    try {
        pdfDoc = await pdf_lib_1.PDFDocument.load(pdfBuffer);
    }
    catch (err) {
        if (err.message.includes('encrypted')) {
            throw new SignPdfError_1.SignPdfError('Problem loading PDF, PDF encrypted', SignPdfError_1.ERROR_TYPE_PARSE);
        }
        else {
            throw err;
        }
    }
    const date = new Date();
    const arrayByteRange = pdf_lib_1.PDFArray.withContext(pdfDoc.context);
    arrayByteRange.push(pdf_lib_1.PDFNumber.of(0));
    arrayByteRange.push(pdf_lib_1.PDFName.of(byteRangePlaceholder));
    arrayByteRange.push(pdf_lib_1.PDFName.of(byteRangePlaceholder));
    arrayByteRange.push(pdf_lib_1.PDFName.of(byteRangePlaceholder));
    const signatureDictMap = new Map();
    signatureDictMap.set(pdf_lib_1.PDFName.Type, pdf_lib_1.PDFName.of('Sig'));
    signatureDictMap.set(pdf_lib_1.PDFName.of('Filter'), pdf_lib_1.PDFName.of('Adobe.PPKLite'));
    signatureDictMap.set(pdf_lib_1.PDFName.of('SubFilter'), pdf_lib_1.PDFName.of('adbe.pkcs7.detached'));
    signatureDictMap.set(pdf_lib_1.PDFName.of('ByteRange'), arrayByteRange);
    signatureDictMap.set(pdf_lib_1.PDFName.of('Contents'), pdf_lib_1.PDFHexString.fromText('0'.repeat(signatureLength)));
    signatureDictMap.set(pdf_lib_1.PDFName.of('Reason'), pdf_lib_1.PDFString.of(infoSignature.reason));
    signatureDictMap.set(pdf_lib_1.PDFName.of('M'), pdf_lib_1.PDFString.fromDate(date));
    signatureDictMap.set(pdf_lib_1.PDFName.of('ContactInfo'), pdf_lib_1.PDFString.of(infoSignature.contactInfo || ''));
    signatureDictMap.set(pdf_lib_1.PDFName.of('Name'), pdf_lib_1.PDFString.of(infoSignature.name || ''));
    signatureDictMap.set(pdf_lib_1.PDFName.of('Location'), pdf_lib_1.PDFString.of(infoSignature.location || ''));
    const signatureDict = pdf_lib_1.PDFDict.fromMapWithContext(signatureDictMap, pdfDoc.context);
    // Check if pdf already contains acroform field
    const acroFormPosition = pdfBuffer.lastIndexOf('/Type /AcroForm');
    const isAcroFormExists = acroFormPosition !== -1;
    let fieldIds = [];
    let acroFormId;
    if (isAcroFormExists) {
        const pdfSlice = pdfBuffer.slice(acroFormPosition - 12);
        const acroForm = pdfSlice.slice(0, pdfSlice.indexOf('endobj')).toString();
        const acroFormFirsRow = acroForm.split('\n')[0];
        acroFormId = parseInt(acroFormFirsRow.split(' ')[0]);
        const acroFormFields = acroForm.slice(acroForm.indexOf('/Fields [') + 9, acroForm.indexOf(']'));
        fieldIds = acroFormFields
            .split(' ')
            .filter((element, index) => index % 3 === 0)
            .map(fieldId => new pdfkitReferenceMock_1.PDFKitReferenceMock(fieldId));
    }
    const signatureName = 'Signature';
    const info = (infoSignature.name || 'Signed') + '\n' + date.toISOString();
    if (!infoSignature.positionBBox || !infoSignature.positionBBox.left ||
        !infoSignature.positionBBox.bottom || !infoSignature.positionBBox.right ||
        !infoSignature.positionBBox.top) {
        infoSignature.positionBBox = {
            left: 0,
            bottom: 0,
            right: 200,
            top: 50
        };
    }
    const sigAppearanceStreamMapDict = new Map();
    // const FontHelvetica = pdfDoc.embedStandardFont(StandardFonts.Helvetica)
    // const resourcesMap = new Map()
    // const fontMap = new Map()
    // fontMap.set(PDFName.of('Helvetica'), FontHelvetica)
    // resourcesMap.set(PDFName.Font, PDFDict.fromMapWithContext(fontMap, pdfDoc.context))
    // sigAppearanceStreamMapDict.set(
    //   PDFName.of('Resources'),
    //   PDFDict.fromMapWithContext(resourcesMap, pdfDoc.context)
    // )
    sigAppearanceStreamMapDict.set(pdf_lib_1.PDFName.Type, pdf_lib_1.PDFName.XObject);
    sigAppearanceStreamMapDict.set(pdf_lib_1.PDFName.of('Subtype'), pdf_lib_1.PDFName.of('Form'));
    // Define a content stream that defines how the signature field should appear
    // on the PDF. - Table 95 of the PDF specification.
    const sigAppearanceStream = pdf_lib_1.PDFContentStream.of(pdf_lib_1.PDFDict.fromMapWithContext(sigAppearanceStreamMapDict, pdfDoc.context), pdf_lib_1.drawRectangle({
        x: pdf_lib_1.PDFNumber.of(infoSignature.positionBBox.left),
        y: pdf_lib_1.PDFNumber.of(infoSignature.positionBBox.bottom),
        width: pdf_lib_1.PDFNumber.of(infoSignature.positionBBox.right),
        height: pdf_lib_1.PDFNumber.of(infoSignature.positionBBox.top),
        color: pdf_lib_1.rgb(0.95, 0.95, 0.95),
        borderWidth: 3,
        borderColor: pdf_lib_1.rgb(0, 0, 0),
        rotate: pdf_lib_1.degrees(0),
        xSkew: pdf_lib_1.degrees(0),
        ySkew: pdf_lib_1.degrees(0)
    }));
    pdf_lib_1.drawText(pdf_lib_1.PDFHexString.of(info), {
        x: pdf_lib_1.PDFNumber.of(10),
        y: pdf_lib_1.PDFNumber.of(15),
        font: 'Helvetica',
        size: pdf_lib_1.PDFNumber.of(15),
        color: pdf_lib_1.rgb(0.5, 0.5, 0.5),
        rotate: pdf_lib_1.degrees(0),
        xSkew: pdf_lib_1.degrees(0),
        ySkew: pdf_lib_1.degrees(0)
    }).forEach(x => { sigAppearanceStream.push(x); });
    pdf_lib_1.drawRectangle({
        x: pdf_lib_1.PDFNumber.of(4),
        y: pdf_lib_1.PDFNumber.of(4),
        width: pdf_lib_1.PDFNumber.of(192),
        height: pdf_lib_1.PDFNumber.of(2),
        color: pdf_lib_1.rgb(0.5, 0.5, 0.5),
        rotate: pdf_lib_1.degrees(0),
        borderWidth: 0,
        borderColor: pdf_lib_1.rgb(0, 0, 0),
        xSkew: pdf_lib_1.degrees(0),
        ySkew: pdf_lib_1.degrees(0)
    }).forEach(x => { sigAppearanceStream.push(x); });
    const sigAppearanceStreamRef = pdfDoc.context.register(sigAppearanceStream);
    // Define the signature widget annotation - Table 164
    const widgetDictMap = new Map();
    const APMap = new Map();
    const arrayRect = pdf_lib_1.PDFArray.withContext(pdfDoc.context);
    arrayRect.push(pdf_lib_1.PDFNumber.of(50));
    arrayRect.push(pdf_lib_1.PDFNumber.of(50));
    arrayRect.push(pdf_lib_1.PDFNumber.of(300));
    arrayRect.push(pdf_lib_1.PDFNumber.of(100));
    APMap.set(pdf_lib_1.PDFName.of('N'), sigAppearanceStreamRef);
    widgetDictMap.set(pdf_lib_1.PDFName.Type, pdf_lib_1.PDFName.of('Annot'));
    widgetDictMap.set(pdf_lib_1.PDFName.of('Subtype'), pdf_lib_1.PDFName.of('Widget'));
    widgetDictMap.set(pdf_lib_1.PDFName.of('FT'), pdf_lib_1.PDFName.of('Sig'));
    widgetDictMap.set(pdf_lib_1.PDFName.of('Rect'), arrayRect);
    widgetDictMap.set(pdf_lib_1.PDFName.of('V'), signatureDict);
    widgetDictMap.set(pdf_lib_1.PDFName.of('T'), pdf_lib_1.PDFString.of(signatureName + (fieldIds.length + 1)));
    widgetDictMap.set(pdf_lib_1.PDFName.of('F'), pdf_lib_1.PDFNumber.of(4));
    widgetDictMap.set(pdf_lib_1.PDFName.of('P'), pdfDoc.catalog.Pages().Kids().get(0));
    widgetDictMap.set(pdf_lib_1.PDFName.of('AP'), pdf_lib_1.PDFDict.fromMapWithContext(APMap, pdfDoc.context));
    const widgetDict = pdf_lib_1.PDFDict.fromMapWithContext(widgetDictMap, pdfDoc.context);
    const widgetDictRef = pdfDoc.context.register(widgetDict);
    // Add our signature widget to the first page
    // by parameter it should also be sent which pages you want to sign - ojo
    const pages = pdfDoc.getPages();
    const arrayAnnots = pdf_lib_1.PDFArray.withContext(pdfDoc.context);
    arrayAnnots.push(widgetDictRef);
    pages[0].node.set(pdf_lib_1.PDFName.Annots, arrayAnnots);
    // Create an AcroForm object containing our signature widget
    const formDictMap = new Map();
    const arrayFields = pdf_lib_1.PDFArray.withContext(pdfDoc.context);
    arrayFields.push(widgetDictRef);
    formDictMap.set(pdf_lib_1.PDFName.of('SigFlags'), pdf_lib_1.PDFNumber.of(3));
    formDictMap.set(pdf_lib_1.PDFName.of('Fields'), arrayFields);
    const formDict = pdf_lib_1.PDFDict.fromMapWithContext(formDictMap, pdfDoc.context);
    pdfDoc.catalog.set(pdf_lib_1.PDFName.of('AcroForm'), formDict);
    let pdfDocBytes = await pdf_lib_1.PDFWriter.forContext(pdfDoc.context, 1).serializeToBuffer();
    // Delete spaces in ByteRange
    pdfDocBytes = Buffer.from(pdfDocBytes);
    const byteRangePlaceholderContent = [
        0,
        `/${byteRangePlaceholder}`,
        `/${byteRangePlaceholder}`,
        `/${byteRangePlaceholder}`
    ];
    const byteRangeString = `/ByteRange [ ${byteRangePlaceholderContent.join(' ')} ]`;
    let actualByteRange = `/ByteRange [${byteRangePlaceholderContent.join(' ')}]`;
    actualByteRange += '  ';
    const byteRangePos = pdfDocBytes.indexOf(byteRangeString);
    if (byteRangePos !== -1) {
        const byteRangeEnd = byteRangePos + byteRangeString.length;
        pdfDocBytes = Buffer.concat([
            pdfDocBytes.slice(0, byteRangePos),
            Buffer.from(actualByteRange),
            pdfDocBytes.slice(byteRangeEnd),
        ]);
    }
    return Buffer.from(pdfDocBytes);
}
exports.pdflibAddPlaceholder = pdflibAddPlaceholder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGRmbGliQWRkUGxhY2Vob2xkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaGVscGVycy9wZGZsaWJBZGRQbGFjZWhvbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFDQWNpQjtBQUVqQixtQ0FBbUY7QUFDbkYsK0RBQTREO0FBQzVELGtEQUFpRTtBQXNCakUsTUFBTSxXQUFXLEdBQUc7SUFDaEIsZUFBZSxFQUFFLGdDQUF3QjtJQUN6QyxvQkFBb0IsRUFBRSxzQ0FBOEI7Q0FDdkQsQ0FBQztBQUVLLEtBQUssVUFBVSxvQkFBb0IsQ0FBQyxJQUE4QjtJQUNyRSxNQUFNLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxlQUFlLEVBQUUsb0JBQW9CLEVBQUUsR0FBRztRQUN4RSxHQUFHLFdBQVcsRUFBRSxHQUFHLElBQUk7S0FDMUIsQ0FBQztJQUVGLElBQUksTUFBTSxDQUFDO0lBQ1gsSUFBSTtRQUNBLE1BQU0sR0FBRyxNQUFNLHFCQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0tBQzlDO0lBQUMsT0FBTyxHQUFHLEVBQUU7UUFDVixJQUFJLEdBQUcsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxFQUFFO1lBQ25DLE1BQU0sSUFBSSwyQkFBWSxDQUFDLG9DQUFvQyxFQUFFLCtCQUFnQixDQUFDLENBQUM7U0FDbEY7YUFBTTtZQUNILE1BQU0sR0FBRyxDQUFDO1NBQ2I7S0FDSjtJQUNELE1BQU0sSUFBSSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7SUFDeEIsTUFBTSxjQUFjLEdBQUcsa0JBQVEsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQzVELGNBQWMsQ0FBQyxJQUFJLENBQUMsbUJBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNyQyxjQUFjLENBQUMsSUFBSSxDQUFDLGlCQUFPLENBQUMsRUFBRSxDQUFDLG9C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TSxtQkFBUyxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixFQUFFLENBQUM7SUFFcEYsNkJBQTZCO0lBQzdCLFdBQVcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBRXZDLE1BQU0sMkJBQTJCLEdBQUc7UUFDaEMsQ0FBQztRQUNELElBQUksb0JBQW9CLEVBQUU7UUFDMUIsSUFBSSxvQkFBb0IsRUFBRTtRQUMxQixJQUFJLG9CQUFvQixFQUFFO0tBQzdCLENBQUM7SUFDRixNQUFNLGVBQWUsR0FBRyxnQkFBZ0IsMkJBQTJCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7SUFDbEYsSUFBSSxlQUFlLEdBQUcsZUFBZSwyQkFBMkIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztJQUM5RSxlQUFlLElBQUksSUFBSSxDQUFDO0lBQ3hCLE1BQU0sWUFBWSxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsZUFBc0IsQ0FBQyxDQUFDO0lBQ2pFLElBQUksWUFBWSxLQUFLLENBQUMsQ0FBQyxFQUFFO1FBQ3JCLE1BQU0sWUFBWSxHQUFHLFlBQVksR0FBRyxlQUFlLENBQUMsTUFBTSxDQUFDO1FBQzNELFdBQVcsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO1lBQ3hCLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLFlBQVksQ0FBQztZQUNsQyxNQUFNLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQztZQUM1QixXQUFXLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQztTQUNsQyxDQUFDLENBQUM7S0FDTjtJQUNELE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUNwQyxDQUFDO0FBeExELG9EQXdMQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgUERGRG9jdW1lbnQsXG4gICAgUERGV3JpdGVyLFxuICAgIFBERkRpY3QsXG4gICAgUERGTmFtZSxcbiAgICBQREZBcnJheSxcbiAgICBQREZTdHJpbmcsXG4gICAgUERGTnVtYmVyLFxuICAgIFBERkhleFN0cmluZyxcbiAgICBQREZDb250ZW50U3RyZWFtLFxuICAgIGRyYXdUZXh0LFxuICAgIGRyYXdSZWN0YW5nbGUsXG4gICAgZGVncmVlcyxcbiAgICByZ2Jcbn0gZnJvbSAncGRmLWxpYic7XG5cbmltcG9ydCB7IERFRkFVTFRfQllURV9SQU5HRV9QTEFDRUhPTERFUiwgREVGQVVMVF9TSUdOQVRVUkVfTEVOR1RIIH0gZnJvbSAnLi9jb25zdCc7XG5pbXBvcnQgeyBQREZLaXRSZWZlcmVuY2VNb2NrIH0gZnJvbSAnLi9wZGZraXRSZWZlcmVuY2VNb2NrJztcbmltcG9ydCB7IEVSUk9SX1RZUEVfUEFSU0UsIFNpZ25QZGZFcnJvciB9IGZyb20gJy4uL1NpZ25QZGZFcnJvcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgSW5mb1NpZ25hdHVyZSB7XG4gICAgcmVhc29uOiBzdHJpbmc7XG4gICAgY29udGFjdEluZm8/OiBzdHJpbmc7XG4gICAgbmFtZT86IHN0cmluZztcbiAgICBsb2NhdGlvbj86IHN0cmluZztcbiAgICBwb3NpdGlvbkJCb3g/OiB7XG4gICAgICAgIHRvcDogbnVtYmVyLFxuICAgICAgICByaWdodDogbnVtYmVyLFxuICAgICAgICBib3R0b206IG51bWJlcixcbiAgICAgICAgbGVmdDogbnVtYmVyXG4gICAgfTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQZGZsaWJBZGRQbGFjZWhvbGRlck9wdHMge1xuICAgIHBkZkJ1ZmZlcjogQnVmZmVyO1xuICAgIGluZm9TaWduYXR1cmU6IEluZm9TaWduYXR1cmU7XG4gICAgc2lnbmF0dXJlTGVuZ3RoPzogbnVtYmVyO1xuICAgIGJ5dGVSYW5nZVBsYWNlaG9sZGVyPzogc3RyaW5nO1xufVxuXG5jb25zdCBkZWZhdWx0T3B0cyA9IHtcbiAgICBzaWduYXR1cmVMZW5ndGg6IERFRkFVTFRfU0lHTkFUVVJFX0xFTkdUSCxcbiAgICBieXRlUmFuZ2VQbGFjZWhvbGRlcjogREVGQVVMVF9CWVRFX1JBTkdFX1BMQUNFSE9MREVSXG59O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcGRmbGliQWRkUGxhY2Vob2xkZXIob3B0czogUGRmbGliQWRkUGxhY2Vob2xkZXJPcHRzKTogUHJvbWlzZTxCdWZmZXI+IHtcbiAgICBjb25zdCB7IHBkZkJ1ZmZlciwgaW5mb1NpZ25hdHVyZSwgc2lnbmF0dXJlTGVuZ3RoLCBieXRlUmFuZ2VQbGFjZWhvbGRlciB9ID0ge1xuICAgICAgICAuLi5kZWZhdWx0T3B0cywgLi4ub3B0c1xuICAgIH07XG5cbiAgICBsZXQgcGRmRG9jO1xuICAgIHRyeSB7XG4gICAgICAgIHBkZkRvYyA9IGF3YWl0IFBERkRvY3VtZW50LmxvYWQocGRmQnVmZmVyKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgaWYgKGVyci5tZXNzYWdlLmluY2x1ZGVzKCdlbmNyeXB0ZWQnKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IFNpZ25QZGZFcnJvcignUHJvYmxlbSBsb2FkaW5nIFBERiwgUERGIGVuY3J5cHRlZCcsIEVSUk9SX1RZUEVfUEFSU0UpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICB9XG4gICAgfVxuICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IGFycmF5Qnl0ZVJhbmdlID0gUERGQXJyYXkud2l0aENvbnRleHQocGRmRG9jLmNvbnRleHQpO1xuICAgIGFycmF5Qnl0ZVJhbmdlLnB1c2goUERGTnVtYmVyLm9mKDApKTtcbiAgICBhcnJheUJ5dGVSYW5nZS5wdXNoKFBERk5hbWUub2YoYnl0ZVJhbmdlUGxhY2Vob2xkZXIpKTtcbiAgICBhcnJheUJ5dGVSYW5nZS5wdXNoKFBERk5hbWUub2YoYnl0ZVJhbmdlUGxhY2Vob2xkZXIpKTtcbiAgICBhcnJheUJ5dGVSYW5nZS5wdXNoKFBERk5hbWUub2YoYnl0ZVJhbmdlUGxhY2Vob2xkZXIpKTtcbiAgICBjb25zdCBzaWduYXR1cmVEaWN0TWFwID0gbmV3IE1hcCgpO1xuICAgIHNpZ25hdHVyZURpY3RNYXAuc2V0KFBERk5hbWUuVHlwZSwgUERGTmFtZS5vZignU2lnJykpO1xuICAgIHNpZ25hdHVyZURpY3RNYXAuc2V0KFBERk5hbWUub2YoJ0ZpbHRlcicpLCBQREZOYW1lLm9mKCdBZG9iZS5QUEtMaXRlJykpO1xuICAgIHNpZ25hdHVyZURpY3RNYXAuc2V0KFBERk5hbWUub2YoJ1N1YkZpbHRlcicpLCBQREZOYW1lLm9mKCdhZGJlLnBrY3M3LmRldGFjaGVkJykpO1xuICAgIHNpZ25hdHVyZURpY3RNYXAuc2V0KFBERk5hbWUub2YoJ0J5dGVSYW5nZScpLCBhcnJheUJ5dGVSYW5nZSk7XG4gICAgc2lnbmF0dXJlRGljdE1hcC5zZXQoUERGTmFtZS5vZignQ29udGVudHMnKSwgUERGSGV4U3RyaW5nLmZyb21UZXh0KCcwJy5yZXBlYXQoc2lnbmF0dXJlTGVuZ3RoKSkpO1xuICAgIHNpZ25hdHVyZURpY3RNYXAuc2V0KFBERk5hbWUub2YoJ1JlYXNvbicpLCBQREZTdHJpbmcub2YoaW5mb1NpZ25hdHVyZS5yZWFzb24pKTtcbiAgICBzaWduYXR1cmVEaWN0TWFwLnNldChQREZOYW1lLm9mKCdNJyksIFBERlN0cmluZy5mcm9tRGF0ZShkYXRlKSk7XG4gICAgc2lnbmF0dXJlRGljdE1hcC5zZXQoXG4gICAgICAgIFBERk5hbWUub2YoJ0NvbnRhY3RJbmZvJyksXG4gICAgICAgIFBERlN0cmluZy5vZihpbmZvU2lnbmF0dXJlLmNvbnRhY3RJbmZvIHx8ICcnKVxuICAgICk7XG4gICAgc2lnbmF0dXJlRGljdE1hcC5zZXQoUERGTmFtZS5vZignTmFtZScpLCBQREZTdHJpbmcub2YoaW5mb1NpZ25hdHVyZS5uYW1lIHx8ICcnKSk7XG4gICAgc2lnbmF0dXJlRGljdE1hcC5zZXQoUERGTmFtZS5vZignTG9jYXRpb24nKSwgUERGU3RyaW5nLm9mKGluZm9TaWduYXR1cmUubG9jYXRpb24gfHwgJycpKTtcbiAgICBjb25zdCBzaWduYXR1cmVEaWN0ID0gUERGRGljdC5mcm9tTWFwV2l0aENvbnRleHQoc2lnbmF0dXJlRGljdE1hcCwgcGRmRG9jLmNvbnRleHQpO1xuXG4gICAgLy8gQ2hlY2sgaWYgcGRmIGFscmVhZHkgY29udGFpbnMgYWNyb2Zvcm0gZmllbGRcbiAgICBjb25zdCBhY3JvRm9ybVBvc2l0aW9uID0gcGRmQnVmZmVyLmxhc3RJbmRleE9mKCcvVHlwZSAvQWNyb0Zvcm0nKTtcbiAgICBjb25zdCBpc0Fjcm9Gb3JtRXhpc3RzID0gYWNyb0Zvcm1Qb3NpdGlvbiAhPT0gLTE7XG4gICAgbGV0IGZpZWxkSWRzID0gW107XG4gICAgbGV0IGFjcm9Gb3JtSWQ7XG5cbiAgICBpZiAoaXNBY3JvRm9ybUV4aXN0cykge1xuICAgICAgICBjb25zdCBwZGZTbGljZSA9IHBkZkJ1ZmZlci5zbGljZShhY3JvRm9ybVBvc2l0aW9uIC0gMTIpO1xuICAgICAgICBjb25zdCBhY3JvRm9ybSA9IHBkZlNsaWNlLnNsaWNlKDAsIHBkZlNsaWNlLmluZGV4T2YoJ2VuZG9iaicpKS50b1N0cmluZygpO1xuICAgICAgICBjb25zdCBhY3JvRm9ybUZpcnNSb3cgPSBhY3JvRm9ybS5zcGxpdCgnXFxuJylbMF07XG4gICAgICAgIGFjcm9Gb3JtSWQgPSBwYXJzZUludChhY3JvRm9ybUZpcnNSb3cuc3BsaXQoJyAnKVswXSk7XG4gICAgICAgIGNvbnN0IGFjcm9Gb3JtRmllbGRzID0gYWNyb0Zvcm0uc2xpY2UoYWNyb0Zvcm0uaW5kZXhPZignL0ZpZWxkcyBbJykgKyA5LCBhY3JvRm9ybS5pbmRleE9mKCddJykpO1xuICAgICAgICBmaWVsZElkcyA9IGFjcm9Gb3JtRmllbGRzXG4gICAgICAgICAgICAuc3BsaXQoJyAnKVxuICAgICAgICAgICAgLmZpbHRlcigoZWxlbWVudCwgaW5kZXgpID0+IGluZGV4ICUgMyA9PT0gMClcbiAgICAgICAgICAgIC5tYXAoZmllbGRJZCA9PiBuZXcgUERGS2l0UmVmZXJlbmNlTW9jayhmaWVsZElkKSk7XG4gICAgfVxuICAgIGNvbnN0IHNpZ25hdHVyZU5hbWUgPSAnU2lnbmF0dXJlJztcbiAgICBjb25zdCBpbmZvID0gKGluZm9TaWduYXR1cmUubmFtZSB8fCAnU2lnbmVkJykgKyAnXFxuJyArIGRhdGUudG9JU09TdHJpbmcoKTtcbiAgICBpZiAoIWluZm9TaWduYXR1cmUucG9zaXRpb25CQm94IHx8ICFpbmZvU2lnbmF0dXJlLnBvc2l0aW9uQkJveC5sZWZ0IHx8XG4gICAgICAgICFpbmZvU2lnbmF0dXJlLnBvc2l0aW9uQkJveC5ib3R0b20gfHwgIWluZm9TaWduYXR1cmUucG9zaXRpb25CQm94LnJpZ2h0IHx8XG4gICAgICAgICFpbmZvU2lnbmF0dXJlLnBvc2l0aW9uQkJveC50b3AgKSB7XG4gICAgICAgIGluZm9TaWduYXR1cmUucG9zaXRpb25CQm94ID0ge1xuICAgICAgICAgICAgbGVmdDogMCxcbiAgICAgICAgICAgIGJvdHRvbTogMCxcbiAgICAgICAgICAgIHJpZ2h0OiAyMDAsXG4gICAgICAgICAgICB0b3A6IDUwXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgY29uc3Qgc2lnQXBwZWFyYW5jZVN0cmVhbU1hcERpY3QgPSBuZXcgTWFwKCk7XG4gICAgLy8gY29uc3QgRm9udEhlbHZldGljYSA9IHBkZkRvYy5lbWJlZFN0YW5kYXJkRm9udChTdGFuZGFyZEZvbnRzLkhlbHZldGljYSlcbiAgICAvLyBjb25zdCByZXNvdXJjZXNNYXAgPSBuZXcgTWFwKClcbiAgICAvLyBjb25zdCBmb250TWFwID0gbmV3IE1hcCgpXG4gICAgLy8gZm9udE1hcC5zZXQoUERGTmFtZS5vZignSGVsdmV0aWNhJyksIEZvbnRIZWx2ZXRpY2EpXG4gICAgLy8gcmVzb3VyY2VzTWFwLnNldChQREZOYW1lLkZvbnQsIFBERkRpY3QuZnJvbU1hcFdpdGhDb250ZXh0KGZvbnRNYXAsIHBkZkRvYy5jb250ZXh0KSlcbiAgICAvLyBzaWdBcHBlYXJhbmNlU3RyZWFtTWFwRGljdC5zZXQoXG4gICAgLy8gICBQREZOYW1lLm9mKCdSZXNvdXJjZXMnKSxcbiAgICAvLyAgIFBERkRpY3QuZnJvbU1hcFdpdGhDb250ZXh0KHJlc291cmNlc01hcCwgcGRmRG9jLmNvbnRleHQpXG4gICAgLy8gKVxuICAgIHNpZ0FwcGVhcmFuY2VTdHJlYW1NYXBEaWN0LnNldChQREZOYW1lLlR5cGUsIFBERk5hbWUuWE9iamVjdCk7XG4gICAgc2lnQXBwZWFyYW5jZVN0cmVhbU1hcERpY3Quc2V0KFBERk5hbWUub2YoJ1N1YnR5cGUnKSwgUERGTmFtZS5vZignRm9ybScpKTtcblxuICAgIC8vIERlZmluZSBhIGNvbnRlbnQgc3RyZWFtIHRoYXQgZGVmaW5lcyBob3cgdGhlIHNpZ25hdHVyZSBmaWVsZCBzaG91bGQgYXBwZWFyXG4gICAgLy8gb24gdGhlIFBERi4gLSBUYWJsZSA5NSBvZiB0aGUgUERGIHNwZWNpZmljYXRpb24uXG4gICAgY29uc3Qgc2lnQXBwZWFyYW5jZVN0cmVhbSA9IFBERkNvbnRlbnRTdHJlYW0ub2YoXG4gICAgICAgIFBERkRpY3QuZnJvbU1hcFdpdGhDb250ZXh0KHNpZ0FwcGVhcmFuY2VTdHJlYW1NYXBEaWN0LCBwZGZEb2MuY29udGV4dCksXG4gICAgICAgIGRyYXdSZWN0YW5nbGUoe1xuICAgICAgICAgICAgeDogUERGTnVtYmVyLm9mKGluZm9TaWduYXR1cmUucG9zaXRpb25CQm94LmxlZnQpLFxuICAgICAgICAgICAgeTogUERGTnVtYmVyLm9mKGluZm9TaWduYXR1cmUucG9zaXRpb25CQm94LmJvdHRvbSksXG4gICAgICAgICAgICB3aWR0aDogUERGTnVtYmVyLm9mKGluZm9TaWduYXR1cmUucG9zaXRpb25CQm94LnJpZ2h0KSxcbiAgICAgICAgICAgIGhlaWdodDogUERGTnVtYmVyLm9mKGluZm9TaWduYXR1cmUucG9zaXRpb25CQm94LnRvcCksXG4gICAgICAgICAgICBjb2xvcjogcmdiKDAuOTUsIDAuOTUsIDAuOTUpLFxuICAgICAgICAgICAgYm9yZGVyV2lkdGg6IDMsXG4gICAgICAgICAgICBib3JkZXJDb2xvcjogcmdiKDAsIDAsIDApLFxuICAgICAgICAgICAgcm90YXRlOiBkZWdyZWVzKDApLFxuICAgICAgICAgICAgeFNrZXc6IGRlZ3JlZXMoMCksXG4gICAgICAgICAgICB5U2tldzogZGVncmVlcygwKVxuICAgICAgICB9KVxuICAgICk7XG4gICAgZHJhd1RleHQoUERGSGV4U3RyaW5nLm9mKGluZm8pLCB7XG4gICAgICAgIHg6IFBERk51bWJlci5vZigxMCksXG4gICAgICAgIHk6IFBERk51bWJlci5vZigxNSksXG4gICAgICAgIGZvbnQ6ICdIZWx2ZXRpY2EnLFxuICAgICAgICBzaXplOiBQREZOdW1iZXIub2YoMTUpLFxuICAgICAgICBjb2xvcjogcmdiKDAuNSwgMC41LCAwLjUpLFxuICAgICAgICByb3RhdGU6IGRlZ3JlZXMoMCksXG4gICAgICAgIHhTa2V3OiBkZWdyZWVzKDApLFxuICAgICAgICB5U2tldzogZGVncmVlcygwKVxuICAgIH0pLmZvckVhY2goeCA9PiB7IHNpZ0FwcGVhcmFuY2VTdHJlYW0ucHVzaCh4KTsgfSk7XG4gICAgZHJhd1JlY3RhbmdsZSh7XG4gICAgICAgIHg6IFBERk51bWJlci5vZig0KSxcbiAgICAgICAgeTogUERGTnVtYmVyLm9mKDQpLFxuICAgICAgICB3aWR0aDogUERGTnVtYmVyLm9mKDE5MiksXG4gICAgICAgIGhlaWdodDogUERGTnVtYmVyLm9mKDIpLFxuICAgICAgICBjb2xvcjogcmdiKDAuNSwgMC41LCAwLjUpLFxuICAgICAgICByb3RhdGU6IGRlZ3JlZXMoMCksXG4gICAgICAgIGJvcmRlcldpZHRoOiAwLFxuICAgICAgICBib3JkZXJDb2xvcjogcmdiKDAsIDAsIDApLFxuICAgICAgICB4U2tldzogZGVncmVlcygwKSxcbiAgICAgICAgeVNrZXc6IGRlZ3JlZXMoMClcbiAgICB9KS5mb3JFYWNoKHggPT4geyBzaWdBcHBlYXJhbmNlU3RyZWFtLnB1c2goeCk7IH0pO1xuICAgIGNvbnN0IHNpZ0FwcGVhcmFuY2VTdHJlYW1SZWYgPSBwZGZEb2MuY29udGV4dC5yZWdpc3RlcihzaWdBcHBlYXJhbmNlU3RyZWFtKTtcblxuICAgIC8vIERlZmluZSB0aGUgc2lnbmF0dXJlIHdpZGdldCBhbm5vdGF0aW9uIC0gVGFibGUgMTY0XG4gICAgY29uc3Qgd2lkZ2V0RGljdE1hcCA9IG5ldyBNYXAoKTtcbiAgICBjb25zdCBBUE1hcCA9IG5ldyBNYXAoKTtcbiAgICBjb25zdCBhcnJheVJlY3QgPSBQREZBcnJheS53aXRoQ29udGV4dChwZGZEb2MuY29udGV4dCk7XG4gICAgYXJyYXlSZWN0LnB1c2goUERGTnVtYmVyLm9mKDUwKSk7XG4gICAgYXJyYXlSZWN0LnB1c2goUERGTnVtYmVyLm9mKDUwKSk7XG4gICAgYXJyYXlSZWN0LnB1c2goUERGTnVtYmVyLm9mKDMwMCkpO1xuICAgIGFycmF5UmVjdC5wdXNoKFBERk51bWJlci5vZigxMDApKTtcbiAgICBBUE1hcC5zZXQoUERGTmFtZS5vZignTicpLCBzaWdBcHBlYXJhbmNlU3RyZWFtUmVmKTtcblxuICAgIHdpZGdldERpY3RNYXAuc2V0KFBERk5hbWUuVHlwZSwgUERGTmFtZS5vZignQW5ub3QnKSk7XG4gICAgd2lkZ2V0RGljdE1hcC5zZXQoUERGTmFtZS5vZignU3VidHlwZScpLCBQREZOYW1lLm9mKCdXaWRnZXQnKSk7XG4gICAgd2lkZ2V0RGljdE1hcC5zZXQoUERGTmFtZS5vZignRlQnKSwgUERGTmFtZS5vZignU2lnJykpO1xuICAgIHdpZGdldERpY3RNYXAuc2V0KFBERk5hbWUub2YoJ1JlY3QnKSwgYXJyYXlSZWN0KTtcbiAgICB3aWRnZXREaWN0TWFwLnNldChQREZOYW1lLm9mKCdWJyksIHNpZ25hdHVyZURpY3QpO1xuICAgIHdpZGdldERpY3RNYXAuc2V0KFBERk5hbWUub2YoJ1QnKSwgUERGU3RyaW5nLm9mKHNpZ25hdHVyZU5hbWUgKyAoZmllbGRJZHMubGVuZ3RoICsgMSkpKTtcbiAgICB3aWRnZXREaWN0TWFwLnNldChQREZOYW1lLm9mKCdGJyksIFBERk51bWJlci5vZig0KSk7XG4gICAgd2lkZ2V0RGljdE1hcC5zZXQoUERGTmFtZS5vZignUCcpLCBwZGZEb2MuY2F0YWxvZy5QYWdlcygpLktpZHMoKS5nZXQoMCkpO1xuICAgIHdpZGdldERpY3RNYXAuc2V0KFBERk5hbWUub2YoJ0FQJyksIFBERkRpY3QuZnJvbU1hcFdpdGhDb250ZXh0KEFQTWFwLCBwZGZEb2MuY29udGV4dCkpO1xuXG4gICAgY29uc3Qgd2lkZ2V0RGljdCA9IFBERkRpY3QuZnJvbU1hcFdpdGhDb250ZXh0KHdpZGdldERpY3RNYXAsIHBkZkRvYy5jb250ZXh0KTtcbiAgICBjb25zdCB3aWRnZXREaWN0UmVmID0gcGRmRG9jLmNvbnRleHQucmVnaXN0ZXIod2lkZ2V0RGljdCk7XG5cbiAgICAvLyBBZGQgb3VyIHNpZ25hdHVyZSB3aWRnZXQgdG8gdGhlIGZpcnN0IHBhZ2VcbiAgICAvLyBieSBwYXJhbWV0ZXIgaXQgc2hvdWxkIGFsc28gYmUgc2VudCB3aGljaCBwYWdlcyB5b3Ugd2FudCB0byBzaWduIC0gb2pvXG4gICAgY29uc3QgcGFnZXMgPSBwZGZEb2MuZ2V0UGFnZXMoKTtcbiAgICBjb25zdCBhcnJheUFubm90cyA9IFBERkFycmF5LndpdGhDb250ZXh0KHBkZkRvYy5jb250ZXh0KTtcbiAgICBhcnJheUFubm90cy5wdXNoKHdpZGdldERpY3RSZWYpO1xuICAgIHBhZ2VzWzBdLm5vZGUuc2V0KFBERk5hbWUuQW5ub3RzLCBhcnJheUFubm90cyk7XG5cbiAgICAvLyBDcmVhdGUgYW4gQWNyb0Zvcm0gb2JqZWN0IGNvbnRhaW5pbmcgb3VyIHNpZ25hdHVyZSB3aWRnZXRcbiAgICBjb25zdCBmb3JtRGljdE1hcCA9IG5ldyBNYXAoKTtcbiAgICBjb25zdCBhcnJheUZpZWxkcyA9IFBERkFycmF5LndpdGhDb250ZXh0KHBkZkRvYy5jb250ZXh0KTtcbiAgICBhcnJheUZpZWxkcy5wdXNoKHdpZGdldERpY3RSZWYpO1xuICAgIGZvcm1EaWN0TWFwLnNldChQREZOYW1lLm9mKCdTaWdGbGFncycpLCBQREZOdW1iZXIub2YoMykpO1xuICAgIGZvcm1EaWN0TWFwLnNldChQREZOYW1lLm9mKCdGaWVsZHMnKSwgYXJyYXlGaWVsZHMpO1xuICAgIGNvbnN0IGZvcm1EaWN0ID0gUERGRGljdC5mcm9tTWFwV2l0aENvbnRleHQoZm9ybURpY3RNYXAsIHBkZkRvYy5jb250ZXh0KTtcbiAgICBwZGZEb2MuY2F0YWxvZy5zZXQoUERGTmFtZS5vZignQWNyb0Zvcm0nKSwgZm9ybURpY3QpO1xuXG4gICAgbGV0IHBkZkRvY0J5dGVzID0gYXdhaXQgUERGV3JpdGVyLmZvckNvbnRleHQocGRmRG9jLmNvbnRleHQsIDEpLnNlcmlhbGl6ZVRvQnVmZmVyKCk7XG5cbiAgICAvLyBEZWxldGUgc3BhY2VzIGluIEJ5dGVSYW5nZVxuICAgIHBkZkRvY0J5dGVzID0gQnVmZmVyLmZyb20ocGRmRG9jQnl0ZXMpO1xuXG4gICAgY29uc3QgYnl0ZVJhbmdlUGxhY2Vob2xkZXJDb250ZW50ID0gW1xuICAgICAgICAwLFxuICAgICAgICBgLyR7Ynl0ZVJhbmdlUGxhY2Vob2xkZXJ9YCxcbiAgICAgICAgYC8ke2J5dGVSYW5nZVBsYWNlaG9sZGVyfWAsXG4gICAgICAgIGAvJHtieXRlUmFuZ2VQbGFjZWhvbGRlcn1gXG4gICAgXTtcbiAgICBjb25zdCBieXRlUmFuZ2VTdHJpbmcgPSBgL0J5dGVSYW5nZSBbICR7Ynl0ZVJhbmdlUGxhY2Vob2xkZXJDb250ZW50LmpvaW4oJyAnKX0gXWA7XG4gICAgbGV0IGFjdHVhbEJ5dGVSYW5nZSA9IGAvQnl0ZVJhbmdlIFske2J5dGVSYW5nZVBsYWNlaG9sZGVyQ29udGVudC5qb2luKCcgJyl9XWA7XG4gICAgYWN0dWFsQnl0ZVJhbmdlICs9ICcgICc7XG4gICAgY29uc3QgYnl0ZVJhbmdlUG9zID0gcGRmRG9jQnl0ZXMuaW5kZXhPZihieXRlUmFuZ2VTdHJpbmcgYXMgYW55KTtcbiAgICBpZiAoYnl0ZVJhbmdlUG9zICE9PSAtMSkge1xuICAgICAgICBjb25zdCBieXRlUmFuZ2VFbmQgPSBieXRlUmFuZ2VQb3MgKyBieXRlUmFuZ2VTdHJpbmcubGVuZ3RoO1xuICAgICAgICBwZGZEb2NCeXRlcyA9IEJ1ZmZlci5jb25jYXQoW1xuICAgICAgICAgICAgcGRmRG9jQnl0ZXMuc2xpY2UoMCwgYnl0ZVJhbmdlUG9zKSxcbiAgICAgICAgICAgIEJ1ZmZlci5mcm9tKGFjdHVhbEJ5dGVSYW5nZSksXG4gICAgICAgICAgICBwZGZEb2NCeXRlcy5zbGljZShieXRlUmFuZ2VFbmQpLFxuICAgICAgICBdKTtcbiAgICB9XG4gICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHBkZkRvY0J5dGVzKTtcbn1cbiJdfQ==